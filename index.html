<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Translation App</title>
  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    .sticky-save {
      position: sticky;
      top: 0;
      z-index: 1050;
      background-color: white;
      padding: 10px 0;
      border-bottom: 1px solid #ddd;
    }
    .sentence-block {
      margin-bottom: 15px;
      border: 1px solid #ddd;
      border-radius: 8px;
      padding: 15px;
    }
    .word-list {
      margin-top: 10px;
      padding-left: 0;
      list-style-type: none;
    }
    .word-list li {
      display: flex;
      align-items: center;
      margin-bottom: 5px;
    }
    .word-list label {
      margin-right: 10px;
      font-weight: bold;
    }
    .word-list input {
      flex: 1;
    }
  </style>
</head>
<body>
  <div class="container my-4">
    <div class="sticky-save">
      <button id="saveButton" class="btn btn-success w-100">Save</button>
      <input type="file" id="uploadFile" class="form-control mt-2" accept="application/json">
    </div>
    <h1 class="text-center my-4">Translation App</h1>
    <div id="app" class="p-3 border rounded">
      <div class="input-group mb-3">
        <input type="text" id="originalInput" class="form-control" placeholder="Enter a sentence">
        <button id="nextButton" class="btn btn-primary">Next</button>
      </div>
      <div id="translations"></div>
    </div>
  </div>

  <!-- Bootstrap JS and dependencies -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    const sentences = [];
    let sequence = 1;

    const originalInput = document.getElementById('originalInput');
    const nextButton = document.getElementById('nextButton');
    const saveButton = document.getElementById('saveButton');
    const uploadFile = document.getElementById('uploadFile');
    const translationsDiv = document.getElementById('translations');

    function renderSentences() {
      translationsDiv.innerHTML = '';
      const reversedSentences = [...sentences].reverse(); // Reverse order for UI display
      reversedSentences.forEach((sentence, index) => {
        const originalIndex = sentences.indexOf(sentence); // Preserve the correct index from the original array

        const block = document.createElement('div');
        block.className = 'sentence-block';
        block.dataset.index = originalIndex;

        block.innerHTML = `
          <div class="mb-2">
            <label>Original Sentence</label>
            <input type="text" class="form-control original" value="${sentence.original}">
            <button class="btn btn-warning btn-sm mt-2 change-sentence">Change</button>
            <button class="btn btn-danger btn-sm mt-2 delete-sentence">Delete</button>
          </div>
          <div class="mb-2">
            <label>Translation</label>
            <input type="text" class="form-control translation" value="${sentence.translation || ''}" placeholder="Enter translation">
          </div>
          <ul class="word-list">
            ${sentence.original
              .split(' ')
              .map(
                (word) => `
                <li>
                  <label>${word}</label>
                  <input type="text" class="form-control word-meaning" data-word="${word}" value="${sentence.word_translations[word]?.translation || ''}" placeholder="Add meaning">
                </li>
              `
              )
              .join('')}
          </ul>
        `;

        // Change button for original sentence
        block.querySelector('.change-sentence').addEventListener('click', () => {
          const newOriginal = block.querySelector('.original').value.trim();
          const oldWords = Object.keys(sentences[originalIndex].word_translations);
          const newWords = newOriginal.split(' ');

          // Update words in word_translations
          const updatedTranslations = {};
          newWords.forEach((word) => {
            if (oldWords.includes(word)) {
              updatedTranslations[word] = sentences[originalIndex].word_translations[word];
            } else {
              updatedTranslations[word] = { translation: '' };
            }
          });

          sentences[originalIndex].original = newOriginal;
          sentences[originalIndex].word_translations = updatedTranslations;

          renderSentences();
        });

        // Update translation in sentences array
        block.querySelector('.translation').addEventListener('focus', (e) => {
          e.target.select();
        });

        block.querySelector('.translation').addEventListener('input', (e) => {
          sentences[originalIndex].translation = e.target.value;
        });

        // Update word meanings in sentences array
        const wordInputs = block.querySelectorAll('.word-meaning');
        wordInputs.forEach((input) => {
          input.addEventListener('input', (e) => {
            const word = e.target.dataset.word;
            sentences[originalIndex].word_translations[word] = {
              translation: e.target.value,
            };
          });
        });

        // Delete sentence
        block.querySelector('.delete-sentence').addEventListener('click', () => {
          sentences.splice(originalIndex, 1);
          reassignSequences();
          renderSentences();
        });

        translationsDiv.appendChild(block);
      });

      // Focus on the translation input of the newest sentence
      if (translationsDiv.firstChild) {
        const newestBlock = translationsDiv.firstChild;
        newestBlock.querySelector('.translation').focus();
      }
    }

    function addSentence() {
      const original = originalInput.value.trim();
      if (original) {
        const wordTranslations = {};
        original.split(' ').forEach((word) => {
          wordTranslations[word] = { translation: '' };
        });

        sentences.push({
          sequence: sequence++, // Add sequence to the sentence
          original,
          translation: '',
          word_translations: wordTranslations,
        });
        renderSentences();
        originalInput.value = '';
      }
    }

    function reassignSequences() {
      sentences.forEach((sentence, index) => {
        sentence.sequence = index + 1;
      });
      sequence = sentences.length + 1;
    }

    nextButton.addEventListener('click', addSentence);

    originalInput.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') {
        e.preventDefault();
        addSentence();
      }
    });

    saveButton.addEventListener('click', saveData);

    // Save data as JSON and download
    function saveData() {
      const json = JSON.stringify({ sentences }, null, 2);
      const blob = new Blob([json], { type: 'application/json' });
      const link = document.createElement('a');
      link.href = URL.createObjectURL(blob);
      link.download = 'translations.json';
      link.click();
    }

    // Load data from JSON file
    uploadFile.addEventListener('change', (e) => {
      const file = e.target.files[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = (event) => {
          try {
            const data = JSON.parse(event.target.result);
            if (data.sentences && Array.isArray(data.sentences)) {
              sentences.length = 0;
              data.sentences.forEach((sentence) => sentences.push(sentence));
              reassignSequences();
              renderSentences();
              alert('File loaded successfully!');
            } else {
              alert('Invalid file format.');
            }
          } catch (error) {
            alert('Error parsing file: ' + error.message);
          }
        };
        reader.readAsText(file);
      }
    });

    // Add Ctrl+Shift+K shortcut to focus on the input
    document.addEventListener('keydown', (e) => {
      if (e.ctrlKey && e.shiftKey && e.key.toLowerCase() === 'k') {
        e.preventDefault();
        originalInput.focus();
      }
      if (e.ctrlKey && e.key.toLowerCase() === 's') {
        e.preventDefault();
        saveData();
      }
    });
  </script>
</body>
</html>
